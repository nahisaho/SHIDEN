# オーケストレーションスキル

> ユーザーのリクエストを分析し、適切なスキルにルーティングするオーケストレーターです。

## 概要

このスキルは、SHIDENの中央制御として機能し、以下の役割を担います：

1. **意図分析** - ユーザーリクエストの意図を特定
2. **スキルルーティング** - 適切なスキルへの振り分け
3. **マルチスキル連携** - 複合リクエストの分解と実行順序決定
4. **フォールバック処理** - エラー時の代替アプローチ提案

## 意図分析ロジック

### キーワードベースの意図検出

ユーザーのリクエストに含まれるキーワードを分析し、意図を特定します。

#### スキルルーティングテーブル

| キーワード | スキル | 優先度 |
|-----------|--------|--------|
| 授業計画, 指導案, lesson plan, 単元計画 | `lesson-plan.md` | 高 |
| 教材, ワークシート, スライド, クイズ, プリント, 配布資料 | `materials.md` | 高 |
| 評価, ルーブリック, テスト, 採点基準, 成績 | `assessment.md` | 高 |
| 個別指導, 配慮, 支援, 特別支援, 学習障害 | `individual.md` | 高 |
| フィードバック, 振り返り, コメント, 添削 | `feedback.md` | 高 |
| 生活指導, 行動, 相談, 問題行動, 保護者面談 | `guidance.md` | 高 |

#### 複合キーワード判定

複数のキーワードが含まれる場合の優先順位：

1. **明示的な動詞** を優先
   - 「作成」「生成」→ 創作系スキル
   - 「評価」「採点」→ 評価系スキル
   - 「対応」「支援」→ 指導系スキル

2. **目的語** を次に考慮
   - 「授業計画を評価」→ フィードバック（既存計画への評価）
   - 「評価計画を作成」→ 評価設計（新規作成）

### 意図不明時の確認フロー

キーワードから意図が特定できない場合：

```
🤔 どのような教育コンテンツを作成しますか？

1. 📚 **授業計画・指導案** - 授業の流れ、学習活動の設計
2. 📝 **教材** - ワークシート、スライド、クイズなど
3. ✅ **評価** - ルーブリック、テスト問題、採点基準
4. 👤 **個別指導計画** - 特定の学習者への対応策
5. 💬 **フィードバック** - 学習成果へのコメント、振り返り支援
6. 🤝 **生活指導案** - 行動面・生活面での指導計画

番号または内容でお答えください。
```

## マルチスキル連携

### 複合リクエストの検出

以下のパターンで複合リクエストを検出します：

- 「○○と△△を作成」
- 「○○した後に△△も」
- 「○○に基づいて△△を」

### 実行順序の決定

複合リクエストの実行順序：

```
1. 授業計画 (lesson-plan)
   ↓
2. 教材 (materials)
   ↓
3. 評価 (assessment)
   ↓
4. フィードバック (feedback)
```

**理由**: 授業計画が他のスキルの基盤となるため、最初に実行。
評価は授業計画・教材との整合性が必要なため、後で実行。

### 連携例

```
ユーザー: 「一次関数の授業計画とワークシートを作成してください」

処理:
1. meta-prompt.md でコンテキスト収集
2. lesson-plan.md で授業計画生成
3. materials.md で授業計画に基づいたワークシート生成
4. 両方の成果物を統合して提示
```

## フォールバック処理

### スキル実行失敗時

```
申し訳ありません。{スキル名}の処理中にエラーが発生しました。

代替アプローチとして、以下をご提案します：
1. {代替案1}
2. {代替案2}

どちらで進めますか？または、別のリクエストをお聞かせください。
```

### 教育理論の検索

教育理論を参照する必要がある場合は、以下のコマンドを使用してください：

```bash
# 理論の検索
npx shiden theories search "{キーワード}"

# 理論の詳細取得
npx shiden theories get {理論ID}

# 関連理論の取得
npx shiden theories related {理論ID}

# カテゴリ別一覧
npx shiden theories categories
npx shiden theories list --category "{カテゴリ名}"
```

### 情報不足時

```
コンテンツを生成するために、もう少し情報が必要です。

以下のいずれかをお試しください：
1. より具体的なリクエストを入力
2. 対象学年・教科を明記
3. 期待する成果物の形式を指定

例: 「中学2年生の数学で、一次関数のワークシートを作成してください」
```

## スキル間データ受け渡し

### コンテキストの保持

各スキル実行時に以下の情報を `context-manager.md` に保存：

- 生成したコンテンツのID
- 使用したメタプロンプト
- 参照した教育理論
- ユーザーのフィードバック

### 参照パターン

後続のスキルが前のスキルの成果を参照する場合：

```
「前の授業計画を基に」
→ context-manager.md から直前の lesson-plan 出力を取得

「さっきのルーブリックを修正して」
→ context-manager.md から直前の assessment 出力を取得
```

## 出力テンプレート

### スキル選択完了時

```
✅ リクエストを理解しました。

**実行するスキル**: {スキル名}
**処理内容**: {簡潔な説明}

{スキル固有の処理を開始}
```

### マルチスキル実行開始時

```
✅ 複合リクエストを理解しました。

**実行計画**:
1. {スキル1} - {処理内容1}
2. {スキル2} - {処理内容2}

順番に処理を進めます。まず{スキル1}から始めます。
```
